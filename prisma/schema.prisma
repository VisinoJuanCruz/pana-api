// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  CANCELLED
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Customer {
  id        Int               @id @default(autoincrement())
  name      String
  address   String
  phone     String
  balance   Float             @default(0)
  route     String?
  category  String?
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  returns   Return[]
  balances  CustomerBalance[]

  // Pedidos del cliente
  orders          Order[]
  recurringOrders RecurringOrder[]

  // Relación con delivery person habitual
  deliveryRoutes DeliveryRoute[]

  // Precios personalizados
  customPrices CustomerProductPrice[]
}

model DeliveryPerson {
  id      Int      @id @default(autoincrement())
  name    String
  phone   String?
  vehicle String?
  returns Return[]

  // Pedidos asignados
  deliveries Delivery[]

  // Clientes habituales
  routes DeliveryRoute[]
}

model DeliveryRoute {
  id               Int            @id @default(autoincrement())
  customer         Customer       @relation(fields: [customerId], references: [id])
  customerId       Int
  deliveryPerson   DeliveryPerson @relation(fields: [deliveryPersonId], references: [id])
  deliveryPersonId Int
}

model RecurringOrder {
  id         Int      @id @default(autoincrement())
  customer   Customer @relation(fields: [customerId], references: [id])
  customerId Int
  product    Product  @relation(fields: [productId], references: [id])
  productId  Int
  quantity   Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Order {
  id         Int         @id @default(autoincrement())
  customer   Customer    @relation(fields: [customerId], references: [id])
  customerId Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  status     OrderStatus @default(PENDING)
  total      Float       @default(0)
  items      OrderItem[]

  // Relación 1:1 con Delivery
  delivery Delivery?
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  order     Order   @relation(fields: [orderId], references: [id])
  orderId   Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  quantity  Float
  unitPrice Float
  total     Float
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  basePrice   Float
  stock       Float    @default(0)
  unit        String   @default("unidad")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relación con receta
  recipe   Recipe? @relation(fields: [recipeId], references: [id])
  recipeId Int?

  orderItems    OrderItem[]
  deliveryItems DeliveryItem[]
  customPrices  CustomerProductPrice[]
  returnItems   ReturnItem[]

  recurringOrders RecurringOrder[]
}

model RawMaterial {
  id        Int      @id @default(autoincrement())
  name      String
  unit      String
  stock     Float?   @default(0)
  price     Float?   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipeItems RecipeItem[]
}

model Recipe {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ingredients RecipeItem[]
  products    Product[]
}

model RecipeItem {
  id            Int         @id @default(autoincrement())
  recipe        Recipe      @relation(fields: [recipeId], references: [id])
  recipeId      Int
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])
  rawMaterialId Int
  quantity      Float
}

model CustomerProductPrice {
  id          Int      @id @default(autoincrement())
  customer    Customer @relation(fields: [customerId], references: [id])
  customerId  Int
  product     Product  @relation(fields: [productId], references: [id])
  productId   Int
  customPrice Float

  @@unique([customerId, productId])
}

model Delivery {
  id               Int            @id @default(autoincrement())
  date             DateTime       @default(now())
  status           DeliveryStatus @default(PENDING)
  deliveredAt      DateTime?
  deliveryPerson   DeliveryPerson @relation(fields: [deliveryPersonId], references: [id])
  deliveryPersonId Int
  order            Order          @relation(fields: [orderId], references: [id])
  orderId          Int            @unique
  payments         Payment[]
  cashClosures     CashClosure[]
  items            DeliveryItem[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model DeliveryItem {
  id         Int      @id @default(autoincrement())
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  deliveryId Int
  product    Product  @relation(fields: [productId], references: [id])
  productId  Int
  quantity   Float
}

model Payment {
  id         Int      @id @default(autoincrement())
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  deliveryId Int
  amount     Float
  method     String
  createdAt  DateTime @default(now())
}

model CashClosure {
  id         Int      @id @default(autoincrement())
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  deliveryId Int
  total      Float
  createdAt  DateTime @default(now())
}

model Return {
  id               Int      @id @default(autoincrement())
  customerId       Int
  deliveryPersonId Int?
  date             DateTime @default(now())
  notes            String?
  totalLoss        Float    @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  customer       Customer        @relation(fields: [customerId], references: [id])
  deliveryPerson DeliveryPerson? @relation(fields: [deliveryPersonId], references: [id])
  items          ReturnItem[]
}

model ReturnItem {
  id              Int               @id @default(autoincrement())
  returnId        Int
  productId       Int
  quantity        Float
  unitPrice       Float
  totalValue      Float
  reason          String?
  destination     ReturnDestination
  discountApplied Boolean           @default(false)

  product Product @relation(fields: [productId], references: [id])
  return  Return  @relation(fields: [returnId], references: [id])
}

enum ReturnDestination {
  DISCARDED
  RALLADO
  DISCOUNTED
}

model CustomerBalance {
  id          Int      @id @default(autoincrement())
  customerId  Int
  type        String // "CREDIT" o "DEBIT"
  description String?
  amount      Float
  date        DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
}
